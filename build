#!/bin/bash
# $1 this is the config file

echo 'Loading configuration...'

source config/$1

#tests=demo/source/css/*.css
#for t in $tests
#do
#  echo "Processing $t file..."  
#done

echo 'Initializing...'
js=0
jsempty=0
css=0
cssempty=0

echo "JavaScript write path = $COMPILETO"
echo "CSS write path = $COMPILETO"

# If the directory for this type does not exist, create it.
mkdir -p css
mkdir -p js

# Create the current time stamp, we will append this to the end of the file name.
now=$(date +"%Y%m%d%H%M%S")

echo 'Combining CSS and JavaScript files...'
for FILE in $FILES
do
	# Get the extension of the file to be minified
	ext=$(echo $FILE|awk -F . '{print $NF}')

	# Check if the file to be minified is a CSS file
	if [ "$ext" == "css" ]; then

		# Check if we've removed previous files
		if [ "$cssempty" == 0 ]; then

			# Remove previous files
			echo "Executing rm $COMPILETO$1*.css..."
			rm $COMPILETO$1*.css
			# Set flag so as to know previous files have been removed
			cssempty=1
			#cat $FILE >> "$COMPILETO$1-$now.$ext"
		fi

		# Set flag so as to know we have CSS files to combine and minify
		css=1;

	else
		if [ "$jsempty" == 0 ]; then
			echo "Executing rm $JSSOUT$1*.js..."
			rm $COMPILETO$1*.js
			jsempty=1
		fi 
		js=1;
		#cat $FILE >> "$COMPILETO$1-$now.$ext"
	fi

	#cat $FILE >> "$ext/$1-$now.$ext"
	cat $FILE >> "$COMPILETO$1-$now.$ext"
done

echo 'Minifing CSS files...'
if [ "$css" == 1 ]; then
	java -jar yuicompressor/build/yuicompressor-2.4.7.jar "$COMPILETO$1-$now.css" -o "$COMPILETO$1-$now.min.css"
	echo "Wrote $COMPILETO$1-$now.min.css"
fi

echo 'Minifing JavaScript files...'
if [ "$js" == 1 ]; then
	java -jar yuicompressor/build/yuicompressor-2.4.7.jar "$COMPILETO$1-$now.js" -o "$COMPILETO$1-$now.min.js"
	echo "Wrote $COMPILETO$1-$now.min.js"
fi

echo "Process complete :)";




